---
import { statSync, readdirSync, existsSync } from 'fs';
import { join, basename } from 'path';

const publicDir = join(import.meta.dirname, '../../public');
const stateFile = import.meta.env.PUBLIC_STATE_FILE || 'alpine-state.bin';
const stateUrl = import.meta.env.PUBLIC_STATE_URL || '';
const manifest: { url: string; logicalUrl?: string; size: number; label: string }[] = [];
try { manifest.push({ url: '/v86/v86.wasm', size: statSync(join(publicDir, 'v86/v86.wasm')).size, label: 'VM Engine' }); } catch {}
try {
  const brPath = join(publicDir, `v86/${stateFile}.br`);
  const hasBr = existsSync(brPath);
  const downloadUrl = stateUrl || (hasBr ? `/v86/${stateFile}.br` : `/v86/${stateFile}`);
  const displaySize = hasBr ? statSync(brPath).size : statSync(join(publicDir, `v86/${stateFile}`)).size;
  manifest.push({ url: downloadUrl, logicalUrl: stateUrl || `/v86/${stateFile}`, size: displaySize, label: 'Linux VM' });
} catch {}

const musicDir = join(publicDir, 'music')
const tracks: { file: string; name: string }[] = []
if (existsSync(musicDir)) {
  for (const f of readdirSync(musicDir).filter(f => f.toLowerCase().endsWith('.mp3')).sort()) {
    tracks.push({ file: f, name: basename(f, '.mp3') })
  }
}
---

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bashtorio - Unix Pipe Factory</title>
  <meta name="description" content="Build conveyor belt factories that process data through real Unix commands running in an in-browser Linux VM. A Factorio-inspired browser game.">
  <meta name="theme-color" content="#1a1a2e">
  <link rel="canonical" href="https://bashtorio.xyz/">

  <!-- Open Graph -->
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://bashtorio.xyz/">
  <meta property="og:title" content="Bashtorio - Unix Pipe Factory">
  <meta property="og:description" content="Build conveyor belt factories that process data through real Unix commands running in an in-browser Linux VM. A Factorio-inspired browser game.">
  <meta property="og:image" content="https://bashtorio.xyz/og.png">

  <!-- Twitter -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="Bashtorio - Unix Pipe Factory">
  <meta name="twitter:description" content="Build conveyor belt factories that process data through real Unix commands running in an in-browser Linux VM.">
  <meta name="twitter:image" content="https://bashtorio.xyz/og.png">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'JetBrains Mono', 'Segoe UI', system-ui, sans-serif;
      background: var(--ui-bg, #1a1a2e);
      color: #eee;
      overflow: hidden;
    }

    #app {
      width: 100vw;
      height: 100vh;
    }

    @keyframes cursor-blink {
      50% { opacity: 0; }
    }

    @keyframes bar-indeterminate {
      0% { left: -30%; width: 30%; }
      50% { left: 50%; width: 30%; }
      100% { left: 100%; width: 30%; }
    }
  </style>
</head>
<body>
  <div id="app">
    <div id="js-loader" data-manifest={JSON.stringify(manifest)} style="position:fixed;inset:0;background:#000;display:flex;align-items:start;justify-content:center;padding-top:33vh;z-index:9999;font-family:'JetBrains Mono',Consolas,Monaco,'Courier New',monospace">
      <div style="text-align:center;max-width:700px;padding:30px">
        <h1 style="font-size:2.5rem;margin-bottom:5px;color:#fff">ba<span style="color:#00ff41">sh</span>torio<span style="display:inline-block;position:relative;bottom:0.15em;font-weight:bold;animation:cursor-blink 1s step-end infinite">_</span></h1>
        <p style="color:#fff;margin-bottom:40px;font-size:1rem">A Unix Pipe Factory Game</p>
        <div id="js-loader-status" style="color:#00ff41;margin-bottom:20px;font-size:0.9rem">Your first time loading might take awhile... it's a full VM.</div>
        <div id="js-loader-bars" style="width:300px;margin:0 auto;text-align:left"></div>
        {tracks.length > 0 && (
          <div id="js-music" data-tracks={JSON.stringify(tracks)} style="margin-top:30px">
            <button id="js-jam-btn" style="background:none;border:1px solid #00ff41;color:#00ff41;font-family:inherit;font-size:0.85rem;padding:6px 18px;border-radius:4px;cursor:pointer;transition:background 0.15s,color 0.15s">Jam Out</button>
            <button id="js-stfu-btn" style="display:none;background:none;border:1px solid #ff4141;color:#ff4141;font-family:inherit;font-size:0.85rem;padding:6px 18px;border-radius:4px;cursor:pointer;transition:background 0.15s,color 0.15s;margin-left:8px">STFU</button>
            <div id="js-now-playing" style="color:#888;font-size:0.75rem;margin-top:8px;display:none"></div>
          </div>
        )}
      </div>
    </div>
  </div>

  <script is:inline>
    (function() {
      var el = document.getElementById('js-loader');
      if (!el) return;
      var barsContainer = document.getElementById('js-loader-bars');
      var status = document.getElementById('js-loader-status');
      var manifest = JSON.parse(el.dataset.manifest || '[]');
      if (!manifest.length) return;

      function formatSize(bytes) {
        if (bytes >= 1048576) return (bytes / 1048576).toFixed(1) + ' MB';
        return (bytes / 1024).toFixed(0) + ' KB';
      }

      // Build per-file UI
      var files = [];
      for (var i = 0; i < manifest.length; i++) {
        var item = manifest[i];
        var row = document.createElement('div');
        row.style.cssText = 'margin-bottom:12px';

        var header = document.createElement('div');
        header.style.cssText = 'display:flex;justify-content:space-between;margin-bottom:4px';

        var label = document.createElement('span');
        label.style.cssText = 'color:#aaa;font-size:0.75rem';
        label.textContent = item.label;

        var info = document.createElement('span');
        info.style.cssText = 'color:#555;font-size:0.75rem';
        info.textContent = '0% of ' + formatSize(item.size);

        header.appendChild(label);
        header.appendChild(info);

        var track = document.createElement('div');
        track.style.cssText = 'width:100%;height:6px;background:#111;border:1px solid #333;border-radius:3px;overflow:hidden';

        var bar = document.createElement('div');
        bar.style.cssText = 'height:100%;width:0%;background:#00ff41;border-radius:2px;transition:width 0.15s ease-out';

        track.appendChild(bar);
        row.appendChild(header);
        row.appendChild(track);
        barsContainer.appendChild(row);

        files.push({ url: item.url, logicalUrl: item.logicalUrl || item.url, size: item.size, loaded: 0, bar: bar, info: info, done: false });
      }

      var allDone = 0;

      function renderFile(f) {
        var p = f.size ? Math.min(100, Math.round(f.loaded / f.size * 100)) : 100;
        f.bar.style.width = p + '%';
        f.info.textContent = f.done ? formatSize(f.size) : p + '% of ' + formatSize(f.size);
        if (f.done) f.info.style.color = '#00ff41';
      }

      function trackFetch(f) {
        return fetch(f.url).then(function(res) {
          var reader = res.body.getReader();
          var chunks = [];
          return new Promise(function(resolve) {
            function pump() {
              reader.read().then(function(result) {
                if (result.done) {
                  f.done = true; f.loaded = f.size; allDone++;
                  renderFile(f);
                  if (allDone >= files.length) status.textContent = 'Initializing...';
                  var total = 0;
                  for (var i = 0; i < chunks.length; i++) total += chunks[i].length;
                  var merged = new Uint8Array(total);
                  var offset = 0;
                  for (var i = 0; i < chunks.length; i++) {
                    merged.set(chunks[i], offset);
                    offset += chunks[i].length;
                  }
                  if (f.url.endsWith('.br')) {
                    status.textContent = 'Decompressing VM state...';
                    var ds = new DecompressionStream('br');
                    var writer = ds.writable.getWriter();
                    writer.write(merged);
                    writer.close();
                    new Response(ds.readable).arrayBuffer().then(function(buf) {
                      resolve(buf);
                    }).catch(function() { resolve(null); });
                  } else {
                    resolve(merged.buffer);
                  }
                  return;
                }
                chunks.push(result.value);
                f.loaded += result.value.length;
                renderFile(f);
                pump();
              }).catch(function() { f.done = true; allDone++; renderFile(f); resolve(null); });
            }
            pump();
          });
        }).catch(function() { f.done = true; allDone++; renderFile(f); return null; });
      }

      var promises = [];
      for (var i = 0; i < files.length; i++) {
        promises.push(trackFetch(files[i]));
      }
      window.__preloadReady = Promise.all(promises).then(function(buffers) {
        window.__preloadBuffers = {};
        for (var i = 0; i < files.length; i++) {
          if (buffers[i]) window.__preloadBuffers[files[i].logicalUrl] = buffers[i];
        }
      });
    })();
  </script>

  <script is:inline>
    (function() {
      var wrap = document.getElementById('js-music');
      if (!wrap) return;
      var btn = document.getElementById('js-jam-btn');
      var stfu = document.getElementById('js-stfu-btn');
      var np = document.getElementById('js-now-playing');
      var tracks = JSON.parse(wrap.dataset.tracks || '[]');
      if (!tracks.length) return;

      var bag = [];
      var audio = null;
      var playing = false;

      function shuffle(arr) {
        for (var i = arr.length - 1; i > 0; i--) {
          var j = Math.floor(Math.random() * (i + 1));
          var t = arr[i]; arr[i] = arr[j]; arr[j] = t;
        }
        return arr;
      }

      function fillBag() {
        bag = [];
        for (var i = 0; i < tracks.length; i++) bag.push(i);
        shuffle(bag);
      }

      function nextIndex() {
        if (!bag.length) fillBag();
        return bag.pop();
      }

      function playTrack() {
        if (audio) { audio.pause(); audio.src = ''; }
        var idx = nextIndex();
        var track = tracks[idx];
        audio = new Audio('/music/' + track.file);
        audio.play();
        playing = true;
        var label = track.name;
        np.textContent = 'Now playing: ' + label;
        np.style.display = '';
        btn.textContent = 'Next Track';
        btn.style.background = '#00ff41';
        btn.style.color = '#000';
        stfu.style.display = '';
        audio.addEventListener('ended', function() { playTrack(); });
      }

      function stopMusic() {
        if (audio) { audio.pause(); audio.src = ''; audio = null; }
        playing = false;
        np.style.display = 'none';
        stfu.style.display = 'none';
        btn.textContent = 'Jam Out';
        btn.style.background = 'none';
        btn.style.color = '#00ff41';
      }

      btn.addEventListener('click', function() { playTrack(); });
      stfu.addEventListener('click', function() { stopMusic(); });

      // Clean up when loader is removed
      var observer = new MutationObserver(function(mutations) {
        for (var i = 0; i < mutations.length; i++) {
          for (var j = 0; j < mutations[i].removedNodes.length; j++) {
            if (mutations[i].removedNodes[j].id === 'js-loader') {
              if (audio) { audio.pause(); audio.src = ''; }
              observer.disconnect();
              return;
            }
          }
        }
      });
      observer.observe(document.getElementById('app'), { childList: true });
    })();
  </script>

  <script>
    import 'bashtorio-core/style.css';
    import '../scripts/game';
  </script>
</body>
</html>
